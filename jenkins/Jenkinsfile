pipeline {
    agent any
    environment {
        AWS_CREDENTIALS = credentials('<JENKINS_AWS_CREDS_ID>')
        SSH_CREDENTIALS = credentials('<JENKINS_SSH_CREDS_ID>')
        TF_WORKDIR = 'terraform/envs/dev'
        scr_app_bucket = '<BUCKET_NAME>' // replace with your bucket name or inject via Jenkins credentials
    }

    stages{
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build Frontend') {
            steps {
                // build from repo root where package.json and src/ reside
                bat 'npm ci'
                bat 'npm run build'
                // sanity check for backend purposes
                bat '''
                  if [ ! -d "src/server" ] || [ ! -d "src/backend" ] || [ ! -d "src/api" ]; then
                    echo "ackend detected under src/"
                    touch backend_present.flag
                  else
                    echo "No backend detected unde src/"
                  fi
                '''
            }
        }

        stage('Terraform Init and Plan') {
            steps {
                dir("${env.TF_WORKDIR}") {
                    withCredntials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: env.AWS_CREDENTIALS]]) {
                        bat 'terraform init -input=false'
                        bat 'terraform fmt -check || true'
                        bat 'terraform validate || true'
                        bat 'terraform plan -input=false -out=tfplan'
                    }
                }
            }
        }

        stage('Terraform Apply') {
            steps {
                dir("${env.TF_WORKDIR}") {
                    withCredntials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: env.AWS_CREDENTIALS]]) {
                        bat 'terraform apply -input=false tfplan'
                    }
                }
            }
        }

        stage('Upload to S3') {
            steps {
                withCredntials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: env.AWS_CREDENTIALS]]) {
                    bat 'aws s3 sync build/ s3://${scr_app_bucket} --acl public-read'
                    // optional: invalidate cloudfront if you store the distribution id in env var
                    // bat "aws cloudfront create-invalidation --distribution-id ${CLOUDFRONT_ID} --paths '/*'"
                    // the build commands now run from repo root: sync uses the build/ artifact produced there
                }
            }
        }

        stage('Generate Inventory and Ansible Deploy') {
            steps {
                script {
                    if (fileExists('backend_present.flag')) {
                        echo 'Backend present â€” running inventory generator and Ansible'
                        dir('jenkins/scripts') {
                          sh 'chmod +x generate_inventory.sh || true'
                          sh "./generate_inventory.sh ../../terraform/envs/dev"
                        }
                        sh "ansible-playbook -i ansible/inventory.ini ansible/playbooks/deploy-backend.yml --private-key ~/.ssh/<YOUR_KEY_FILE>"
                    } else {
                        echo 'No backend detected - skipping Ansible deploy'
                    }
                }
            }
        }

        post {
            always {
                echo 'Pipeline finished'
            }
            failure {
                echo 'Pipeline failed'
            }
        }
    }
}

// backend_present.flag is a siple presence marker; Jenkins runs Ansible only if server code exists under src/