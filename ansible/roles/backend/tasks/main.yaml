- name: Ensure apt cache updated
  apt:
    update_cache: yes
  become: yes

- name: Ensure Node.js (18) and build tools installed
  apt_key:
    url: https://deb.nodesource.com/gpgkey/nodesource.gpg.key
  become: yes
  when: ansible_os_family == 'Debian' or ansible_distribution == 'Ubuntu'

- name: Add NodeSource repo
  apt_repository:
    repo: "deb https://deb.nodesource.com/node_18.x {{ ansible_lsb.codename }} main"
    state: present
  become: yes
  when: ansible_os_family == 'Debian' or ansible_distribution == 'Ubuntu'

- name: Install packages
  apt:
    name: [nodejs, build-essential]
    state: present
    update_cache: yes
  become: yes

- name: Create app directory
  file:
    path: /opt/backend
    state: directory
    owner: appuser
    group: appuser
  become: yes

- name: Copy backend code from repo src/server (if present)
  synchronize:
    src: "{{ playbook_dir }}/../../src/server/"
    dest: /opt/backend/
    rsync_opts: ['--archive','--delete']
  become: yes

- name: Install npm dependencies (if package.json exists)
  stat:
    path: /opt/backend/package.json
  register: backend_pkg
  become: yes

- name: Run npm ci
  command: npm ci
  args:
    chdir: /opt/backend
  when: backend_pkg.stat.exists
  become: yes

- name: Run DB migrations / create table if not exists
  shell: |
    psql "host=${DB_HOST} port=${DB_PORT} user=${DB_USER} password=${DB_PASSWORD} dbname=${DB_NAME}" -f /opt/backend/sql/schema.sql
  environment:
    PGPASSWORD: "{{ lookup('env','DB_PASSWORD') | default('') }}"
  register: migration
  failed_when: false
  changed_when: "'CREATE TABLE' in (migration.stdout + migration.stderr)"
  become: yes
  when: backend_pkg.stat.exists

- name: Create systemd service file
  template:
    src: backend.service.j2
    dest: /etc/systemd/system/backend.service
    mode: '0644'
  become: yes
  when: backend_pkg.stat.exists

- name: Reload systemd
  systemd:
    daemon_reload: yes
  become: yes
  when: backend_pkg.stat.exists

- name: Enable and start backend
  systemd:
    name: backend.service
    enabled: yes
    state: restarted
  become: yes
  when: backend_pkg.stat.exists
